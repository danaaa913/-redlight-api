<!-- admin-dashboard.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø²Ø§Ù‡Ø©</title>
  <style>
    * { box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: #f8f9fa;
      color: #2c3e50;
    }
    
    .header {
      background: #2c3e50;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      margin: 0;
      font-size: 1.8em;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logout-btn {
      background: #e74c3c;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
    }
    
    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .high-priority { color: #e74c3c; }
    .medium-priority { color: #f39c12; }
    .low-priority { color: #27ae60; }
    
    .institutions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    
    .institution-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 25px;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .institution-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .institution-name {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #2c3e50;
    }
    
    .institution-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .stat-item {
      text-align: center;
      padding: 10px;
      border-radius: 5px;
      background: #f8f9fa;
    }
    
    .priority-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      color: white;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background: white;
      margin: 50px auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    
    .close {
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 2em;
      cursor: pointer;
      color: #aaa;
    }
    
    .close:hover {
      color: #e74c3c;
    }
    
    .summary-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-right: 4px solid #3498db;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ›ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø²Ø§Ù‡Ø©</h1>
    <div class="user-info">
      <span id="userInfo">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</span>
      <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="container">
    <div id="loadingStats" class="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</div>
    
    <div id="dashboard" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalInstitutions">0</div>
          <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª</div>
        </div>
        <div class="stat-card">
          <div class="stat-number high-priority" id="highPriority">0</div>
          <div>Ù…Ø¤Ø³Ø³Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</div>
        </div>
        <div class="stat-card">
          <div class="stat-number medium-priority" id="mediumPriority">0</div>
          <div>Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</div>
        </div>
        <div class="stat-card">
          <div class="stat-number low-priority" id="lowPriority">0</div>
          <div>Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</div>
        </div>
      </div>

      <h2>ğŸ¢ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ©</h2>
      <div id="institutionsGrid" class="institutions-grid"></div>
    </div>
  </div>

  <!-- Modal Ù„Ù„Ù…Ù„Ø®Øµ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ -->
  <div id="summaryModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modalContent">
        <div class="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø°ÙƒÙŠ...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://redlight-api.onrender.com';
    let adminToken = localStorage.getItem('adminToken');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    if (!adminToken) {
      window.location.href = 'admin-login.html';
    }

    // ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    const adminInfo = JSON.parse(localStorage.getItem('adminInfo') || '{}');
    document.getElementById('userInfo').textContent = adminInfo.organization || 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„';

    async function loadInstitutions() {
      try {
        const response = await fetch(`${API_BASE}/api/admin/institutions`, {
          headers: {
            'Authorization': `Bearer ${adminToken}`
          }
        });

        const data = await response.json();
        
        if (response.status === 401) {
          logout();
          return;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        document.getElementById('totalInstitutions').textContent = data.summary.total;
        document.getElementById('highPriority').textContent = data.summary.highPriority;
        document.getElementById('mediumPriority').textContent = data.summary.mediumPriority;
        document.getElementById('lowPriority').textContent = data.summary.lowPriority;

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª
        const grid = document.getElementById('institutionsGrid');
        grid.innerHTML = '';

        data.institutions.forEach(inst => {
          const card = document.createElement('div');
          card.className = 'institution-card';
          card.onclick = () => showInstitutionSummary(inst.name);
          
          const priorityClass = inst.priority === 'Ø¹Ø§Ù„ÙŠØ©' ? 'high-priority' : 
                               inst.priority === 'Ù…ØªÙˆØ³Ø·Ø©' ? 'medium-priority' : 'low-priority';
          
          card.innerHTML = `
            <div class="institution-name">${inst.name}</div>
            <div class="institution-stats">
              <div class="stat-item">
                <div><strong>${inst.integrityScore}%</strong></div>
                <div>Ù…Ø¤Ø´Ø± Ø§Ù„Ù†Ø²Ø§Ù‡Ø©</div>
              </div>
              <div class="stat-item">
                <div><strong>${inst.totalFeedbacks}</strong></div>
                <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
              </div>
            </div>
            <div class="priority-badge ${priorityClass}" style="background: ${
              inst.priority === 'Ø¹Ø§Ù„ÙŠØ©' ? '#e74c3c' : 
              inst.priority === 'Ù…ØªÙˆØ³Ø·Ø©' ? '#f39c12' : '#27ae60'
            }">
              Ø£ÙˆÙ„ÙˆÙŠØ© ${inst.priority}
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
              Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${new Date(inst.lastActivity).toLocaleDateString('ar')}
            </div>
          `;
          
          grid.appendChild(card);
        });

        // Ø¥Ø®ÙØ§Ø¡ loading ÙˆØ¥Ø¸Ù‡Ø§Ø± dashboard
        document.getElementById('loadingStats').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';

      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª:', error);
        document.getElementById('loadingStats').innerHTML = `
          <div style="color: #e74c3c;">
            âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª<br>
            <button onclick="loadInstitutions()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
          </div>
        `;
      }
    }

    async function showInstitutionSummary(institutionName) {
      const modal = document.getElementById('summaryModal');
      const modalContent = document.getElementById('modalContent');
      
      modal.style.display = 'block';
      modalContent.innerHTML = '<div class="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø°ÙƒÙŠ...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/admin/institution/${encodeURIComponent(institutionName)}/summary`, {
          headers: {
            'Authorization': `Bearer ${adminToken}`
          }
        });

        const summary = await response.json();

        modalContent.innerHTML = `
          <h2>ğŸ“Š ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ: ${summary.institution}</h2>
          
          <div class="stats-grid" style="margin: 20px 0;">
            <div class="stat-card">
              <div class="stat-number" style="color: ${summary.riskColor}">${summary.integrityScore}%</div>
              <div>Ù…Ø¤Ø´Ø± Ø§Ù„Ù†Ø²Ø§Ù‡Ø©</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${summary.totalFeedbacks}</div>
              <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" style="color: ${summary.riskColor}">${summary.riskLevel}</div>
              <div>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</div>
            </div>
          </div>

          <div class="summary-section">
            <h3>ğŸ“ˆ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
              <div>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙØ³Ø§Ø¯: <strong>${summary.scores.corruption}%</strong></div>
              <div>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ø¯Ø§Ù„Ø©: <strong>${summary.scores.fairness}%</strong></div>
              <div>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ÙŠØ©: <strong>${summary.scores.nepotism}%</strong></div>
              <div>Ø¬ÙˆØ¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø©: <strong>${summary.scores.service}%</strong></div>
            </div>
          </div>

          <div class="summary-section">
            <h3>ğŸ” Ø£Ø¨Ø±Ø² Ø§Ù„Ù…Ø´Ø§ÙƒÙ„</h3>
            <ul>
              ${summary.topIssues.map(issue => 
                `<li><strong>${issue.issue}</strong> (${issue.count} Ù…Ø±Ø© - ${issue.percentage}%)</li>`
              ).join('')}
            </ul>
          </div>

          <div class="summary-section">
            <h3>ğŸ¤– Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</h3>
            <div style="white-space: pre-wrap; line-height: 1.6;">${summary.aiGeneratedSummary}</div>
          </div>

          <div class="summary-section">
            <h3>ğŸ“ Ø£Ù…Ø«Ù„Ø© Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h3>
            ${summary.recentFeedbacks.map(fb => `
              <div style="background: #f1f2f6; padding: 15px; margin: 10px 0; border-radius: 8px;">
                <div style="font-size: 0.9em; color: #555; margin-bottom: 5px;">
                  ${new Date(fb.date).toLocaleDateString('ar')} - ${fb.sentiment === 'positive' ? 'ğŸ˜Š Ø¥ÙŠØ¬Ø§Ø¨ÙŠ' : fb.sentiment === 'negative' ? 'ğŸ˜ Ø³Ù„Ø¨ÙŠ' : 'ğŸ˜ Ù…Ø­Ø§ÙŠØ¯'}
                </div>
                <div>"${fb.text}"</div>
              </div>
            `).join('')}
          </div>
        `;

      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø®Øµ:', error);
        modalContent.innerHTML = `
          <div style="color: #e74c3c; text-align: center; padding: 50px;">
            âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø®Øµ<br>
            <button onclick="showInstitutionSummary('${institutionName}')">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
          </div>
        `;
      }
    }

    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminInfo');
      window.location.href = 'admin-login.html';
    }

    // Ø¥ØºÙ„Ø§Ù‚ modal
    document.querySelector('.close').onclick = function() {
      document.getElementById('summaryModal').style.display = 'none';
    }

    window.onclick = function(event) {
      const modal = document.getElementById('summaryModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    loadInstitutions();

    // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
    setInterval(loadInstitutions, 300000);
  </script>
</body>
</html>
