<!-- admin-dashboard.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>🏛️ لوحة التحكم - هيئة النزاهة</title>
  <style>
    * { box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: #f8f9fa;
      color: #2c3e50;
    }
    
    .header {
      background: #2c3e50;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      margin: 0;
      font-size: 1.8em;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logout-btn {
      background: #e74c3c;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
    }
    
    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .high-priority { color: #e74c3c; }
    .medium-priority { color: #f39c12; }
    .low-priority { color: #27ae60; }
    
    .institutions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    
    .institution-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 25px;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .institution-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .institution-name {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #2c3e50;
    }
    
    .institution-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .stat-item {
      text-align: center;
      padding: 10px;
      border-radius: 5px;
      background: #f8f9fa;
    }
    
    .priority-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      color: white;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background: white;
      margin: 50px auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    
    .close {
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 2em;
      cursor: pointer;
      color: #aaa;
    }
    
    .close:hover {
      color: #e74c3c;
    }
    
    .summary-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-right: 4px solid #3498db;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🏛️ لوحة تحكم هيئة النزاهة</h1>
    <div class="user-info">
      <span id="userInfo">المسؤول</span>
      <button class="logout-btn" onclick="logout()">خروج</button>
    </div>
  </div>

  <div class="container">
    <div id="loadingStats" class="loading">⏳ جاري تحميل الإحصائيات...</div>
    
    <div id="dashboard" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalInstitutions">0</div>
          <div>إجمالي المؤسسات</div>
        </div>
        <div class="stat-card">
          <div class="stat-number high-priority" id="highPriority">0</div>
          <div>مؤسسات عالية الأولوية</div>
        </div>
        <div class="stat-card">
          <div class="stat-number medium-priority" id="mediumPriority">0</div>
          <div>متوسطة الأولوية</div>
        </div>
        <div class="stat-card">
          <div class="stat-number low-priority" id="lowPriority">0</div>
          <div>منخفضة الأولوية</div>
        </div>
      </div>

      <h2>🏢 المؤسسات الحكومية</h2>
      <div id="institutionsGrid" class="institutions-grid"></div>
    </div>
  </div>

  <!-- Modal للملخص التفصيلي -->
  <div id="summaryModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modalContent">
        <div class="loading">⏳ جاري تحميل الملخص الذكي...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://redlight-api.onrender.com';
    let adminToken = localStorage.getItem('adminToken');

    // التحقق من المصادقة
    if (!adminToken) {
      window.location.href = 'admin-login.html';
    }

    // تحميل معلومات المسؤول
    const adminInfo = JSON.parse(localStorage.getItem('adminInfo') || '{}');
    document.getElementById('userInfo').textContent = adminInfo.organization || 'المسؤول';

    async function loadInstitutions() {
      try {
        const response = await fetch(`${API_BASE}/api/admin/institutions`, {
          headers: {
            'Authorization': `Bearer ${adminToken}`
          }
        });

        const data = await response.json();
        
        if (response.status === 401) {
          logout();
          return;
        }

        // تحديث الإحصائيات
        document.getElementById('totalInstitutions').textContent = data.summary.total;
        document.getElementById('highPriority').textContent = data.summary.highPriority;
        document.getElementById('mediumPriority').textContent = data.summary.mediumPriority;
        document.getElementById('lowPriority').textContent = data.summary.lowPriority;

        // عرض المؤسسات
        const grid = document.getElementById('institutionsGrid');
        grid.innerHTML = '';

        data.institutions.forEach(inst => {
          const card = document.createElement('div');
          card.className = 'institution-card';
          card.onclick = () => showInstitutionSummary(inst.name);
          
          const priorityClass = inst.priority === 'عالية' ? 'high-priority' : 
                               inst.priority === 'متوسطة' ? 'medium-priority' : 'low-priority';
          
          card.innerHTML = `
            <div class="institution-name">${inst.name}</div>
            <div class="institution-stats">
              <div class="stat-item">
                <div><strong>${inst.integrityScore}%</strong></div>
                <div>مؤشر النزاهة</div>
              </div>
              <div class="stat-item">
                <div><strong>${inst.totalFeedbacks}</strong></div>
                <div>عدد الرسائل</div>
              </div>
            </div>
            <div class="priority-badge ${priorityClass}" style="background: ${
              inst.priority === 'عالية' ? '#e74c3c' : 
              inst.priority === 'متوسطة' ? '#f39c12' : '#27ae60'
            }">
              أولوية ${inst.priority}
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
              آخر نشاط: ${new Date(inst.lastActivity).toLocaleDateString('ar')}
            </div>
          `;
          
          grid.appendChild(card);
        });

        // إخفاء loading وإظهار dashboard
        document.getElementById('loadingStats').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';

      } catch (error) {
        console.error('خطأ في تحميل المؤسسات:', error);
        document.getElementById('loadingStats').innerHTML = `
          <div style="color: #e74c3c;">
            ❌ خطأ في تحميل البيانات<br>
            <button onclick="loadInstitutions()">إعادة المحاولة</button>
          </div>
        `;
      }
    }

    async function showInstitutionSummary(institutionName) {
      const modal = document.getElementById('summaryModal');
      const modalContent = document.getElementById('modalContent');
      
      modal.style.display = 'block';
      modalContent.innerHTML = '<div class="loading">⏳ جاري تحميل الملخص الذكي...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/admin/institution/${encodeURIComponent(institutionName)}/summary`, {
          headers: {
            'Authorization': `Bearer ${adminToken}`
          }
        });

        const summary = await response.json();

        modalContent.innerHTML = `
          <h2>📊 تقرير تفصيلي: ${summary.institution}</h2>
          
          <div class="stats-grid" style="margin: 20px 0;">
            <div class="stat-card">
              <div class="stat-number" style="color: ${summary.riskColor}">${summary.integrityScore}%</div>
              <div>مؤشر النزاهة</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${summary.totalFeedbacks}</div>
              <div>إجمالي الرسائل</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" style="color: ${summary.riskColor}">${summary.riskLevel}</div>
              <div>مستوى المخاطر</div>
            </div>
          </div>

          <div class="summary-section">
            <h3>📈 المؤشرات التفصيلية</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
              <div>مستوى الفساد: <strong>${summary.scores.corruption}%</strong></div>
              <div>مستوى العدالة: <strong>${summary.scores.fairness}%</strong></div>
              <div>مستوى المحسوبية: <strong>${summary.scores.nepotism}%</strong></div>
              <div>جودة الخدمة: <strong>${summary.scores.service}%</strong></div>
            </div>
          </div>

          <div class="summary-section">
            <h3>🔍 أبرز المشاكل</h3>
            <ul>
              ${summary.topIssues.map(issue => 
                `<li><strong>${issue.issue}</strong> (${issue.count} مرة - ${issue.percentage}%)</li>`
              ).join('')}
            </ul>
          </div>

          <div class="summary-section">
            <h3>🤖 التحليل الذكي</h3>
            <div style="white-space: pre-wrap; line-height: 1.6;">${summary.aiGeneratedSummary}</div>
          </div>

          <div class="summary-section">
            <h3>📝 أمثلة من الرسائل الأخيرة</h3>
            ${summary.recentFeedbacks.map(fb => `
              <div style="background: #f1f2f6; padding: 15px; margin: 10px 0; border-radius: 8px;">
                <div style="font-size: 0.9em; color: #555; margin-bottom: 5px;">
                  ${new Date(fb.date).toLocaleDateString('ar')} - ${fb.sentiment === 'positive' ? '😊 إيجابي' : fb.sentiment === 'negative' ? '😞 سلبي' : '😐 محايد'}
                </div>
                <div>"${fb.text}"</div>
              </div>
            `).join('')}
          </div>
        `;

      } catch (error) {
        console.error('خطأ في تحميل الملخص:', error);
        modalContent.innerHTML = `
          <div style="color: #e74c3c; text-align: center; padding: 50px;">
            ❌ خطأ في تحميل الملخص<br>
            <button onclick="showInstitutionSummary('${institutionName}')">إعادة المحاولة</button>
          </div>
        `;
      }
    }

    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminInfo');
      window.location.href = 'admin-login.html';
    }

    // إغلاق modal
    document.querySelector('.close').onclick = function() {
      document.getElementById('summaryModal').style.display = 'none';
    }

    window.onclick = function(event) {
      const modal = document.getElementById('summaryModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // تحميل البيانات عند بدء التطبيق
    loadInstitutions();

    // تحديث تلقائي كل 5 دقائق
    setInterval(loadInstitutions, 300000);
  </script>
</body>
</html>
