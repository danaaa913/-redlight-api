<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>خريطة المؤسسات الحكومية الأردنية - RedLight AI</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
    /* صفحة البداية */
    #landing {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:#2c3e50; display:flex; flex-direction:column;
      align-items:center; justify-content:center; text-align:center; color:#fff; z-index:2000;
    }
    #landing h1 { font-size:48px; margin:0; }
    #landing h1 .red { color:#e74c3c; }
    #landing p.tagline { margin:15px 0 30px; font-size:20px; max-width:600px; }
    #start-button {
      padding:15px 30px; font-size:24px; background-color:#e74c3c; color:#fff;
      border:none; border-radius:6px; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.3);
    }
    /* شريط البحث */
    #search-bar {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      z-index:1000; width:90%; max-width:600px; display:flex; background:rgba(255,255,255,0.9);
      border-radius:4px; box-shadow:0 2px 6px rgba(0,0,0,0.3);
    }
    #search-input {
      flex:1; padding:10px 15px; border:1px solid #ccc; border-radius:4px 0 0 4px; font-size:16px; outline:none;
    }
    #search-button {
      padding:10px 20px; background-color:#0077cc; color:#fff; border:none; border-radius:0 4px 4px 0; cursor:pointer; font-size:16px;
    }
    /* الخريطة */
    #map { height:100%; width:100%; }
    /* صندوق الملاحظات */
    #feedback-modal {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1500;
    }
    #feedback-box {
      background:#fff; padding:20px; border-radius:6px; width:90%; max-width:500px;
      box-shadow:0 4px 8px rgba(0,0,0,0.3); text-align:center;
    }
    #feedback-box h3 { margin-top:0; font-size:20px; }
    #feedback-text {
      width:100%; height:120px; margin:15px 0; padding:10px; font-size:16px;
      border:1px solid #ccc; border-radius:4px; resize:vertical;
    }
    #feedback-submit, #feedback-cancel {
      padding:10px 20px; font-size:16px; border:none; border-radius:4px; cursor:pointer; margin:5px;
    }
    #feedback-submit { background:#0077cc; color:#fff; }
    #feedback-cancel { background:#ccc; }
  </style>
</head>
<body>
  <!-- صفحة البداية -->
  <div id="landing">
    <h1>أهلاً وسهلاً بك في <span class="red">RedLight AI</span></h1>
    <p class="tagline">"الصمت لا يعني الرضى بل إنذار مبكر"</p>
    <button id="start-button">ابدأ الاستكشاف</button>
  </div>
  <!-- شريط البحث والخريطة -->
  <div id="search-bar" style="display:none;">
    <input id="search-input" type="text" placeholder="ابحث عن المؤسسة الحكومية..." />
    <button id="search-button">بحث</button>
  </div>
  <div id="map" style="display:none;"></div>
  <!-- صندوق الملاحظات -->
  <div id="feedback-modal">
    <div id="feedback-box">
      <h3 id="feedback-title">شارك تجربتك مع ...</h3>
      <textarea id="feedback-text" placeholder="اكتب تجربتك هنا"></textarea>
      <div>
        <button id="feedback-submit">إرسال</button>
        <button id="feedback-cancel">إلغاء</button>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map, markers = [], currentInstitution = '';
    
    // ✅ رابط API المُصحح - يُرسل دائماً للخادم الحقيقي
    const API_BASE = 'https://redlight-api.onrender.com';
    
    function initMap() {
      map = L.map('map').setView([31.9454,35.9284],7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'© OpenStreetMap'
      }).addTo(map);
      const institutions = [
  // الوزارات الأساسية
  { name: 'رئاسة الوزراء', coords: [31.9539, 35.9106] },
  { name: 'وزارة الداخلية', coords: [31.9522, 35.9106] },
  { name: 'وزارة الخارجية', coords: [31.9500, 35.9200] },
  { name: 'وزارة العدل', coords: [31.9619, 35.9284] },
  { name: 'وزارة المالية', coords: [31.9466, 35.9321] },
  { name: 'وزارة التربية والتعليم', coords: [31.9336, 35.8681] },
  { name: 'وزارة التعليم العالي والبحث العلمي', coords: [31.9400, 35.8700] },
  { name: 'وزارة الصحة', coords: [31.9622, 35.8846] },
  { name: 'وزارة الأوقاف والشؤون الإسلامية', coords: [31.9550, 35.9100] },
  { name: 'وزارة الثقافة', coords: [31.9600, 35.9150] },
  { name: 'وزارة الصناعة والتجارة', coords: [31.9450, 35.9250] },
  { name: 'وزارة العمل', coords: [31.9480, 35.9180] },
  { name: 'وزارة النقل', coords: [31.9420, 35.9120] },
  { name: 'وزارة الطاقة والثروة المعدنية', coords: [31.9380, 35.9080] },
  { name: 'وزارة البيئة', coords: [31.9520, 35.9220] },
  { name: 'وزارة السياحة والآثار', coords: [31.9580, 35.9280] },
  { name: 'وزارة التنمية الاجتماعية', coords: [31.9440, 35.9160] },
  { name: 'وزارة الشباب', coords: [31.9460, 35.9140] },
  { name: 'وزارة الأشغال العامة والإسكان', coords: [31.9400, 35.9200] },
  { name: 'وزارة الشؤون البلدية', coords: [31.9350, 35.9050] },
  
  // الجامعات الرئيسية
  { name: 'الجامعة الأردنية', coords: [31.9394, 35.8714] },
  { name: 'جامعة العلوم والتكنولوجيا الأردنية', coords: [32.4892, 35.9901] },
  { name: 'جامعة اليرموك', coords: [32.5569, 35.8531] },
  { name: 'جامعة مؤتة', coords: [31.0536, 35.7341] },
  { name: 'الجامعة الهاشمية', coords: [32.1394, 36.2008] },
  { name: 'جامعة البلقاء التطبيقية', coords: [32.0459, 35.7278] },
  { name: 'جامعة الطفيلة التقنية', coords: [30.8389, 35.6153] },
  { name: 'جامعة الحسين بن طلال', coords: [30.1848, 35.7085] },
  { name: 'الجامعة الألمانية الأردنية', coords: [31.8661, 35.8678] },
  { name: 'جامعة عمان الأهلية', coords: [31.8996, 35.9778] },
  
  // المستشفيات الحكومية الرئيسية
  { name: 'مستشفى الجامعة الأردنية', coords: [31.9394, 35.8714] },
  { name: 'مستشفى الملك المؤسس عبدالله', coords: [31.9500, 35.9300] },
  { name: 'مستشفى البشير', coords: [31.9650, 35.8800] },
  { name: 'مستشفى الأميرة بسمة', coords: [32.5500, 35.8500] },
  { name: 'مستشفى الأمير حمزة', coords: [31.9800, 35.9100] },
  { name: 'مستشفى الملك حسين', coords: [31.9600, 35.9200] },
  
  // البلديات الكبرى
  { name: 'أمانة عمان الكبرى', coords: [31.9454, 35.9284] },
  { name: 'بلدية إربد الكبرى', coords: [32.5556, 35.8500] },
  { name: 'بلدية الزرقاء', coords: [32.0732, 36.0881] },
  { name: 'بلدية العقبة', coords: [29.5267, 35.0074] },
  { name: 'بلدية السلط', coords: [32.0390, 35.7270] },
  { name: 'بلدية معان', coords: [30.1962, 35.7340] },
  { name: 'بلدية الكرك', coords: [31.1854, 35.7049] },
  { name: 'بلدية جرش', coords: [32.2811, 35.8989] },
  { name: 'بلدية عجلون', coords: [32.3328, 35.7517] },
  { name: 'بلدية الطفيلة', coords: [30.8378, 35.6153] },
  { name: 'بلدية مأدبا', coords: [31.7197, 35.7956] },
  { name: 'بلدية المفرق', coords: [32.3436, 36.2081] },
  
  // الهيئات والمؤسسات المستقلة
  { name: 'هيئة النزاهة ومكافحة الفساد', coords: [31.9500, 35.9150] },
  { name: 'ديوان المحاسبة', coords: [31.9520, 35.9180] },
  { name: 'ديوان الخدمة المدنية', coords: [31.9480, 35.9120] },
  { name: 'البنك المركزي الأردني', coords: [31.9540, 35.9240] },
  { name: 'هيئة تنظيم الاتصالات', coords: [31.9400, 35.9100] },
  { name: 'هيئة تنظيم الطيران المدني', coords: [31.7226, 35.9938] },
  { name: 'مؤسسة الضمان الاجتماعي', coords: [31.9350, 35.9200] },
  { name: 'صندوق استثمار أموال الضمان الاجتماعي', coords: [31.9380, 35.9220] },
  
  // المؤسسات الاقتصادية
  { name: 'غرفة تجارة عمان', coords: [31.9600, 35.9300] },
  { name: 'غرفة صناعة عمان', coords: [31.9580, 35.9280] },
  { name: 'بورصة عمان', coords: [31.9620, 35.9320] },
  { name: 'شركة الكهرباء الأردنية', coords: [31.9450, 35.9180] },
  { name: 'شركة المياه الأردنية (مياهنا)', coords: [31.9400, 35.9160] },
  { name: 'الخطوط الجوية الملكية الأردنية', coords: [31.7226, 35.9938] },
  
  // المؤسسات الإعلامية والثقافية
  { name: 'وكالة الأنباء الأردنية (بترا)', coords: [31.9550, 35.9200] },
  { name: 'التلفزيون الأردني', coords: [31.9500, 35.9180] },
  { name: 'الإذاعة الأردنية', coords: [31.9480, 35.9160] },
  { name: 'دار الإفتاء العام', coords: [31.9570, 35.9130] },
  { name: 'دائرة الأراضي والمساحة', coords: [31.9420, 35.9140] },
  
  // مؤسسات أخرى مهمة
  { name: 'مجلس النواب الأردني', coords: [31.9600, 35.9100] },
  { name: 'مجلس الأعيان', coords: [31.9580, 35.9080] },
  { name: 'المجلس الأعلى للقضاء', coords: [31.9620, 35.9120] },
  { name: 'نقابة المهندسين الأردنيين', coords: [31.9550, 35.9250] },
  { name: 'نقابة الأطباء الأردنيين', coords: [31.9530, 35.9230] }
];

      markers = institutions.map(inst => {
        const m = L.marker(inst.coords).addTo(map);
        m.bindPopup(
          `<strong>${inst.name}</strong><br>` +
          `<button onclick="openFeedbackForm('${inst.name}')">شارك تجربتك</button>`
        );
        return { name: inst.name, marker: m };
      });
    }
    
    document.getElementById('start-button').addEventListener('click', () => {
      document.getElementById('landing').style.display = 'none';
      document.getElementById('search-bar').style.display = 'flex';
      document.getElementById('map').style.display = 'block';
      initMap();
    });
    
    function performSearch() {
      const q = document.getElementById('search-input').value.trim();
      if (!q) return;
      const found = markers.find(m => m.name.includes(q));
      if (found) {
        map.setView(found.marker.getLatLng(),13);
        found.marker.openPopup();
      } else {
        alert('لم يتم العثور على المؤسسة المطلوبة');
      }
    }
    
    document.getElementById('search-button').addEventListener('click', performSearch);
    document.getElementById('search-input').addEventListener('keyup', e => { 
      if (e.key==='Enter') performSearch(); 
    });
    
    function openFeedbackForm(name) {
      currentInstitution = name;
      document.getElementById('feedback-title').textContent = `شارك تجربتك مع ${name}`;
      document.getElementById('feedback-text').value = '';
      document.getElementById('feedback-modal').style.display = 'flex';
    }
    
    // ✅ وظيفة الإرسال المُصححة
    document.getElementById('feedback-submit').addEventListener('click', () => {
      const t = document.getElementById('feedback-text').value.trim();
      if (!t) { 
        alert('يرجى كتابة تجربتك أولاً'); 
        return; 
      }
      
      // ✅ الآن يُرسل دائماً للخادم الحقيقي
      const url = `${API_BASE}/api/feedback`;
      const payload = {
        institutionName: currentInstitution,
        timestamp: new Date().toISOString(),
        text: t
      };
      
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => {
        if (!res.ok) throw new Error('فشل في إرسال التجربة');
        return res.json();
      })
      .then(data => {
        console.log('Response:', data);
        alert('تم الإرسال بنجاح! شكراً لك على مشاركة تجربتك'); 
        document.getElementById('feedback-modal').style.display = 'none';
        document.getElementById('feedback-text').value = ''; // تنظيف النموذج
      })
      .catch(err => {
        console.error('خطأ في الإرسال:', err);
        alert('حدث خطأ أثناء الإرسال، يرجى المحاولة مرة أخرى');
      });
    });
    
    document.getElementById('feedback-cancel').addEventListener('click', () => {
      document.getElementById('feedback-modal').style.display = 'none';
    });
  </script>
</body>
</html>
